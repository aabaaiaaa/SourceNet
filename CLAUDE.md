# CLAUDE.md

## Commands
- `npm run dev` - Start dev server (http://localhost:5173)
- `npm test` - Run unit tests (613 tests)
- `npm run test:e2e` - Run E2E tests (103 tests)
- `npm run lint` - Run ESLint
- `npm run test:e2e:generate` - Regenerate debug scenario fixtures

## Architecture

**State Management:**
- `src/contexts/GameContext.jsx` - Central game state provider (1800+ lines)
- `src/contexts/useGame.js` - Hook to access game state (always import from here, not GameContext)
- `src/core/triggerEventBus.js` - Pub/sub event bus for decoupled communication

**Key Folders:**
- `src/components/apps/` - In-game applications (BankingApp, SNetMail, FileManager, etc.)
- `src/missions/data/` - JSON mission definitions
- `src/systems/` - Game systems (BankingSystem, ReputationSystem, etc.)
- `src/debug/` - Debug panel and scenario loading

## Game Time System

Components that need delays or timers must respect game time speed:
- Use `scheduleGameTimeCallback(callback, delayMs, timeSpeed)` from `src/core/gameTimeScheduler.js`
- Access `timeSpeed` from `useGame()` - values defined in `src/constants/gameConstants.js`:
  - `TIME_SPEEDS.NORMAL` = 1 (normal speed)
  - `TIME_SPEEDS.FAST` = 10 (in-game fast forward)
  - `TIME_SPEEDS.TEST` = 100 (automated testing only)
- Game can be paused (`isPaused` from context)
- **Never use raw `setTimeout` for in-game delays** - they won't scale with time speed

**Setting time speed:**
- In-game UI uses `toggleTimeSpeed()` - toggles between 1x and 10x only
- For tests, use `setSpecificTimeSpeed(speed)` to set any value including 100x:
  - Unit tests: `const { setSpecificTimeSpeed } = useGame(); setSpecificTimeSpeed(100);`
  - E2E tests: `await page.evaluate(() => window.gameContext.setSpecificTimeSpeed(100));`

## Mission System

**Structure:**
- `src/missions/data/*.json` - Mission definitions (objectives, triggers, rewards)
- `src/missions/StoryMissionManager.js` - Singleton that orchestrates story missions
- `src/missions/ObjectiveTracker.js` - Monitors game state for objective completion
- `src/missions/ScriptedEventExecutor.js` - Executes scripted events (delays, messages, etc.)
- `src/missions/useStoryMissions.js` - React hook that connects missions to game context

**Story Events:**
- Missions can trigger scripted events via `scriptedEvents` array in mission JSON
- Events fire on triggers like `missionAccepted`, `objectiveCompleted`, `missionCompleted`
- Event types: `sendMessage`, `delay`, `unlockSoftware`, etc.

**Triggers:**
- Events emitted via `triggerEventBus`: `desktopLoaded`, `networkConnected`, `messageRead`, `softwareInstalled`, etc.
- Story missions listen for triggers to activate

## Save/Load System

**Save Data** (stored in localStorage):
- Multiple save slots supported
- Key state saved: `gamePhase`, `username`, `currentTime`, `bankAccounts`, `messages`, `windows`, `activeMission`, `completedMissions`, `reputation`, `software`, `narEntries`, etc.
- Time speed always resets to 1x on load

**Important:**
- New state added to GameContext must be added to both `getSaveData()` and `loadGame()` functions
- Windows are persisted with position, z-index, and minimized state

## Debug System

**URL Parameters:**
- `?debug=true` - Enable debug mode
- `?skipBoot=true` - Skip boot sequence
- `?scenario=<name>` - Load a scenario directly (skips boot, goes to desktop with scenario state)
- Example: `http://localhost:5173/?scenario=fresh-start&debug=true`

**Debug Panel:** Ctrl+Shift+D (only available with `?debug=true`)
- Tabs: Scenarios, State Controls, Event Log
- Load scenarios to jump to specific game states instantly

**Scenarios:**
- Pre-built game states for testing specific situations
- Defined in `src/debug/scenarios.js`
- JSON fixtures generated by E2E tests in `e2e/generators/`
- Run `npm run test:e2e:generate` to regenerate fixtures

## Conventions
- Prefix unused parameters with `_`
- Test files: `Component.test.jsx` co-located with source
- Only `fileManager` allows multiple window instances (see `MULTI_INSTANCE_APPS` in gameConstants.js)

## Testing

**E2E Helpers** (`e2e/helpers/common-actions.js`):
- `completeBootAndLogin(page)` - Full boot sequence
- `openApp(page, appName)` - Open app from launcher
- `setSpecificTimeSpeed(page, speed)` - Set game time speed (use 100 for fast tests)

**Unit Tests:**
- `triggerEventBus.clear()` is called automatically between tests
- Wrap components in `GameProvider` for testing

## Gotchas
- Game time starts at March 25, 2020 09:00:00
- Time speed resets to 1x on save/load
- Event bus persists between tests - setup.js handles clearing
- Story missions have `"oneTime": true` - check `completedMissions` to prevent re-triggering
